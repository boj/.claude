#!/usr/bin/env bash
set -e

CLAUDE_DIR="$HOME/.claude"
ROLE="${1:-engineer}"

# Help message
if [ "$ROLE" = "-h" ] || [ "$ROLE" = "--help" ]; then
    echo "Usage: claude-as [ROLE] [CLAUDE_ARGS...]"
    echo ""
    echo "Activate a Claude Code archetype and start a session."
    echo ""
    echo "Available roles:"
    for dir in "$CLAUDE_DIR/archetypes"/*/; do
        role=$(basename "$dir")
        echo "  $role"
    done
    echo ""
    echo "Examples:"
    echo "  claude-as engineer          # Start as engineer (default)"
    echo "  claude-as analyst           # Start as business analyst"
    echo "  claude-as devops            # Start as devops engineer"
    echo "  claude-as engineer --model opus  # With additional args"
    exit 0
fi

# List available roles
if [ "$ROLE" = "-l" ] || [ "$ROLE" = "--list" ]; then
    echo "Available roles:"
    for dir in "$CLAUDE_DIR/archetypes"/*/; do
        role=$(basename "$dir")
        echo "  $role"
    done
    exit 0
fi

# Validate role
if [ ! -d "$CLAUDE_DIR/archetypes/$ROLE" ]; then
    echo "Error: Unknown role '$ROLE'"
    echo ""
    echo "Available roles:"
    for dir in "$CLAUDE_DIR/archetypes"/*/; do
        role=$(basename "$dir")
        echo "  $role"
    done
    exit 1
fi

# Check for required files
if [ ! -f "$CLAUDE_DIR/CLAUDE.base.md" ]; then
    echo "Error: Missing $CLAUDE_DIR/CLAUDE.base.md"
    exit 1
fi

if [ ! -f "$CLAUDE_DIR/archetypes/$ROLE/context.md" ]; then
    echo "Error: Missing $CLAUDE_DIR/archetypes/$ROLE/context.md"
    exit 1
fi

if [ ! -f "$CLAUDE_DIR/archetypes/$ROLE/permissions.json" ]; then
    echo "Error: Missing $CLAUDE_DIR/archetypes/$ROLE/permissions.json"
    exit 1
fi

# Combine base rules with role-specific context
{
    echo "# Generated by claude-as - Role: $ROLE"
    echo "# Generated at: $(date)"
    echo ""
    cat "$CLAUDE_DIR/CLAUDE.base.md"
    echo ""
    cat "$CLAUDE_DIR/archetypes/$ROLE/context.md"
} > "$CLAUDE_DIR/CLAUDE.md"

# Copy role permissions
cp "$CLAUDE_DIR/archetypes/$ROLE/permissions.json" "$CLAUDE_DIR/settings.json"

echo "Activated role: $ROLE"
echo "  Rules: $CLAUDE_DIR/CLAUDE.md"
echo "  Permissions: $CLAUDE_DIR/settings.json"
echo ""

# Pass remaining args to claude
shift 2>/dev/null || true
exec claude "$@"
